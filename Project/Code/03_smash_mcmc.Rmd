---
title: "Smash Analysis"
subtitle: "Advanced Models"
author: "Zack Wixom"
output: github_document
---

```{r opts, echo = FALSE}
# puts any figures made into this folder
knitr::opts_chunk$set(
  fig.path = "../Figures/Smash"
)
```

![Super Smash Logo](/Users/zwixom/School/Marketing/Quant Analytics/Repo/zack-wixom/Project/Figures/Smash/super-smash-bros-ultimate.PNG)


```{r set up, message = FALSE}
# Packages
library(tidyverse)
library(cmdstanr)
library(posterior)
library(bayesplot)
library(rethinking)
library(dagitty)

# Load Data
smash_tidy <- read_csv(here::here("Project", "Data", "smash_tidy.csv"))[,-1]

smash_tidy

# Set Seed
set.seed(42)

```

> I might want to check correlation between variables but I want to get started on an MCMC model

### Round 1

Let's look back our latest DAG

- X  = `per_played` the outcome variable
- W = `Weight`: weight
- R = `Run.Speed`: # of frames to pivot dash
- G = `Grab.Range`: range of grab
- F  = `Fast.Fall`: fast fall speed
- H  = `fullhop_height`: height of full hop
- S  = `shorthop_height`: height of short hop


```{r dag5}
# Create DAG
dag5 <- dagitty("dag{
    W -> X; 
    R -> X;
    G -> X;
    W -> R;
    W -> F;
    
    F -> X;    
    H -> X; 
    S -> X
}")

# DAG coordinates
coordinates(dag5) <- list(
  x = c(X = 1, W = 1, S = 2, G = 1, R = 2, F = 0, H = 0),
  y = c(X = 1, W = 0, S = 2, G = 2, R = 0, F = 0, H = 2)
)

# Draw DAG
drawdag(dag5)

```

Let's build an `ulam` model with just the variables by themselves. Then add some interactions.

```{r m2.1}

# Standardize and Index Variables
smash2.1 <- tibble(
  played = standardize(smash_tidy$per_played),
  weight = standardize(smash_tidy$Weight),
  run = standardize(smash_tidy$Run.Speed),
  grab = standardize(as.numeric(smash_tidy$Grab.Range)),
  fall = standardize(smash_tidy$Fast.Fall),
  fullhop = standardize(as.numeric(smash_tidy$fullhop_height)),
  shorthop = standardize(as.numeric(smash_tidy$shorthop_height))
) %>% 
  drop_na()

# Fit Model
m2.1 <- ulam(
  alist(
    played ~ dnorm(mu, sigma),
    mu <- a + bW * weight + bR * run + bG * grab + bF * fall + bH * fullhop + bS * shorthop,
    a ~ dnorm(0, .2),
    c(bW, bR, bG, bF, bH, bS) ~ dnorm(0, 0.2),
    sigma ~ dexp(1)
  ), 
  data = smash2.1,
  chains = 4, 
  cores = 4
)

# Plot Precis
plot(precis(m2.1))


```

Now with some interactions between `wieght` and the jumping variables

- X  = `per_played` the outcome variable
- W = `Weight`: weight
- R = `Run.Speed`: # of frames to pivot dash
- G = `Grab.Range`: range of grab
- F  = `Fast.Fall`: fast fall speed
- H  = `fullhop_height`: height of full hop
- S  = `shorthop_height`: height of short hop

```{r m2.2}

# Standardize and Index Variables
smash2.2 <- tibble(
  played = standardize(smash_tidy$per_played),
  weight = standardize(smash_tidy$Weight),
  run = standardize(smash_tidy$Run.Speed),
  grab = standardize(as.numeric(smash_tidy$Grab.Range)),
  fall = standardize(smash_tidy$Fast.Fall),
  fullhop = standardize(as.numeric(smash_tidy$fullhop_height)),
  shorthop = standardize(as.numeric(smash_tidy$shorthop_height))
) %>% 
  drop_na()

# Fit Model
m2.2 <- ulam(
  alist(
    played ~ dnorm(mu, sigma),
    mu <- a + 
      bW * weight +
      bR * run + 
      bG * grab + 
      bF * fall + 
      bH * fullhop + 
      bS * shorthop +
      bWR * weight * run +
      bWF * weight * fall +
      bWH * weight * fullhop +
      bWS * weight * shorthop,
    a ~ dnorm(0, .2),
    c(bW, bR, bG, bF, bH, bS) ~ dnorm(0, 0.2),
    c(bWR, bWF, bWH, bWS) ~ dnorm(0, 0.05),
    sigma ~ dexp(1)
  ), 
  data = smash2.2,
  chains = 4, 
  cores = 4
)

# Plot Precis
plot(precis(m2.2))


```

So there aren't any significance to the weight interactions. So I won't be worrying about that. 

I am going to try to make weight a discrete variable by classifying characters into weight classes. *Heavy*, *Medium*, and *Light*. 

```{r weight class}

# Find tertiles
vTert = quantile(smash_tidy$Weight, c(0:3/3), na.rm = T)

# classify values
smash_tidy$weight_class = with(smash_tidy, 
                               cut(Weight, 
                                   vTert, 
                                   include.lowest = T, 
                                   labels = c("Light", "Medium", "Heavy")))

smash_tidy %>% 
  select(character, Weight, weight_class)

```

```{r m2.3}

# Standardize and Index Variables
smash2.3 <- tibble(
  played = standardize(smash_tidy$per_played),
  w_class = as.integer(smash_tidy$weight_class),
  weight = standardize(smash_tidy$Weight),
  run = standardize(smash_tidy$Run.Speed),
  grab = standardize(as.numeric(smash_tidy$Grab.Range)),
  fall = standardize(smash_tidy$Fast.Fall),
  fullhop = standardize(as.numeric(smash_tidy$fullhop_height)),
  shorthop = standardize(as.numeric(smash_tidy$shorthop_height))
) %>% 
  drop_na()

# Fit Model
m2.3 <- ulam(
  alist(
    played ~ dnorm(mu, sigma),
    mu <- a[w_class] +
      bR[w_class] * run + 
      bG[w_class] * grab + 
      bF[w_class] * fall + 
      bH[w_class] * fullhop + 
      bS[w_class] * shorthop,
    a[w_class] ~ dnorm(0, .2),
    c(bR, bG, bF, bH, bS)[w_class] ~ dnorm(0, 0.2),
    sigma ~ dexp(1)
  ), 
  data = smash2.3,
  chains = 4, 
  cores = 4
)

# Plot Precis
plot(precis(m2.3, depth = 2))


```

I am going to do a bernoulli distribution for this next one, just to see if there is any difference.

```{r m2.4}
# m2.4 <- ulam(
#   alist(
#     played ~ bernoulli(p),
#     logit(p) <- a[w_class] + 
#       bR[w_class] * run +
#       bG[w_class] * grab + 
#       bF[w_class] * fall + 
#       bH[w_class] * fullhop + 
#       bS[w_class] * shorthop,
#     c(a, bR, bG, bF, bH, bS)[w_class] ~ multi_normal(c(abar, bRbar, bGbar, bFbar, bHbar, bSbar), Rho, Sigma),
#     abar ~ normal(0, 1),
#     c(bRbar, bGbar, bFbar, bHbar, bSbar) ~ normal(0, 0.5),
#     Rho ~ lkj_corr(2),
#     Sigma ~ exponential(1)
#   ),
#   data = smash2.3,
#   chains = 4,
#   cores = 4,
#   cmdstan = TRUE
# )
# 
# # Plot Precis
# plot(precis(m2.4, depth = 2))


```

I got a weird error for not have a csv file name. I am just not going to use bernoulli distribution then.

I am going to just look into my weight class by fullhop, grab, and fall.

```{r m2.5}

# Standardize and Index Variables
smash2.5 <- tibble(
  played = standardize(smash_tidy$per_played),
  w_class = as.integer(smash_tidy$weight_class),
  grab = standardize(as.numeric(smash_tidy$Grab.Range)),
  fall = standardize(smash_tidy$Fast.Fall),
  fullhop = standardize(as.numeric(smash_tidy$fullhop_height))
) %>% 
  drop_na()

# Fit Model
m2.5 <- ulam(
  alist(
    played ~ dnorm(mu, sigma),
    mu <- a[w_class] +
      bG[w_class] * grab + 
      bF[w_class] * fall + 
      bH[w_class] * fullhop,
    a[w_class] ~ dnorm(0, .2),
    c(bG, bF, bH)[w_class] ~ dnorm(0, 0.2),
    sigma ~ dexp(1)
  ), 
  data = smash2.5,
  chains = 4, 
  cores = 4
)

# Plot Precis
plot(precis(m2.5, depth = 2))


```

So I am seeing some influence of weight class on these variables. But nothing is super significant.

There might be an unobserved variable that is causing players choices in choosing characters.

```{r m2.6}

# Standardize and Index Variables
smash2.6 <- tibble(
  played = standardize(smash_tidy$per_played),
  w_class = as.integer(smash_tidy$weight_class),
  grab = standardize(as.numeric(smash_tidy$Grab.Range)),
  fall = standardize(smash_tidy$Fast.Fall),
  fullhop = standardize(as.numeric(smash_tidy$fullhop_height)),
  alpha = rep(2)
) %>% 
  drop_na()

# Fit Model
m2.6 <- ulam(
  alist(
    played ~ ordered_logistic(phi, cutpoints),
    phi <- bW * sum(delta_shell[1:w_class]) + 
      bG * grab +
      bF * fall + 
      bH * fullhop,
    # # Add interactions
    # BI <- bI + bIA*A + bIC*C,
    c(bW, bG, bF, bH) ~ normal(0, 0.5),
    cutpoints ~ normal(0, 1.5),
    vector[8]: delta_shell <<- append_row(0, delta),
    simplex[7]: delta ~ dirichlet(alpha)
  ),
  data = smash2.6,
  chains = 4, 
  cores = 4,
  cmdstan = TRUE
)


```

Well I got the csv file name error again. Not sure what that means and how to fix it, couldn't find anything online about it.
