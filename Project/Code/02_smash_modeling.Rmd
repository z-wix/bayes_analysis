---
title: "Smash Data Analysis"
subtitle: "Beginning Modeling"
author: "Zack Wixom"
output: github_document
---

```{r opts, echo = FALSE}
# puts any figures made into this folder
knitr::opts_chunk$set(
  fig.path = "../Figures/Project/Smash"
)
```

Now that I have data and a success metric that I want to model on. I can start to build out some models. I am going to start with a simple model using quadratic approximation before moving onto a `ulam()`.

### Set Up

First I am going to be loading some packages I will need and import my data from `01_smash_data.Rmd`.

```{r set up, message = FALSE}
# Packages
library(tidyverse)
library(cmdstanr)
library(posterior)
library(bayesplot)
library(rethinking)
library(dagitty)

# Load Data
smash <- read_csv(here::here("Project/Data", "smash_data.csv")) %>% 
  select(-contains("rank")) # Don't need these variables

smash

```

Some of the characters do not have all the frame stats available. I might need to take care of this later if having NA's present cause an issue, but for now I will not worry about them. However, I really don't need the rankings per frame stat, so I will just drop those columns.

### Clean Up Data

**The Outcome Variable**

The variable I will be modeling on is `per_played`. This is a ratio for how often this character is chosen and I want to know what influences peoples choice of each character.

**The Explanatory Variables**

There are a lot of variables in this dataset. So I want to make it simple and just use the most realistic variables that might go into a person's choice of a character. Here is a list of the variables that are most important to gameplay and are used in strategic moves:

- `string1`: character is first string choice
- `base_accel`: base acceleration 
- `Air.speed`: speed in air
- `Fast.Fall`: fast fall speed
- `fullhop_height`: height of full hop
- `shorthop_height`: height of short hop
- `airjump_height`: height of midair jump
- `Weight`: weight
- `Run.Speed`: # of frames to pivot dash
- `Grab.Range`: range of grab
- `Fastest.Move.s.`: Fastest move out of shield

> Note: I do not have damage data as of right now. It might be good to incorporate damage data for certain moves as this could be an indicator of character preference, however, the real reason players are good are because they understand the mechanics of their preferred character and know how to use it. So for a pro the actual damage output might not be as important as knowing how to move and time combos, leading to rampping up damage, and delivering a kill.

```{r filtering data}

vars <- c(1, 4, 5, 8, 11, 13, 16:18, 23, 28, 34, 41)

smash_tidy <- smash %>% 
  select(vars)

```

### Drawing First DAG

Now I will create a DAG that I can use to determine my models. here are my variables that I am going to start with:

- X = `per_played` the outcome variable
- W = `Weight`
- S = `shorthop_height`
- G = `Grab.Range`
- R = `Run.Speed`

These are pretty basic components that should be considered when picking a character. These are *Grab Range*, *Run Speed*, *Short Hop*, and *Weight*. Weight is related to a lot of the other variables, besides Grab. 


```{r dag1}
# Create DAG
dag1 <- dagitty("dag{
    W -> X; 
    S -> X;
    G -> X;
    R -> X;
    W -> S;
    W -> R
}")

# DAG coordinates
coordinates(dag1) <- list(
  x = c(X = 2, W = 2, S = 3, G = 1, R = 1),
  y = c(X = 2, W = 0, S = 0, G = 2, R = 0)
)

# Draw DAG
drawdag(dag1)

```

There are a few interactions that we need to watch. Since it is a fork from W to X, S, and R we will condition all the variables in the model.

### Standardize Variables

We are going to standardize each variable, there are a couple that need to be converted to numeric because of they are character variables.

Here are the variables I will standardize

- played = `per_played` the outcome variable
- weight = `Weight`
- shorthop = `shorthop_height` make numeric to get rid of ~'s
- grab = `Grab.Range` make numeric to get rid of ~'s
- run = `Run.Speed`

```{r standardize data}

# Standardize and Index Variables
smash1 <- tibble(
  played = standardize(smash_tidy$per_played),
  weight = standardize(smash_tidy$Weight),
  shorthop = standardize(as.numeric(smash_tidy$shorthop_height)),
  grab = standardize(as.numeric(smash_tidy$Grab.Range)),
  run = standardize(smash_tidy$Run.Speed)
)

# Initial Density Graphs
dens(smash1$played)
dens(smash1$weight)
dens(smash1$shorthop)
dens(smash1$grab)
dens(smash1$run)

```

There are a couple of outliers happening in grab and run. I think this is because there are a few characters that are known to have this extreme stats. So it is not surprising, but I might need to log these two variables.

I also do not have any discrete varables at the moment. In a later iteration this may change especially as I group by character.

### Build Model

```{r m1}

# Omit NA's
smash1 <- smash1 %>% 
  na.omit()

# Fit Model
m1.1 <- quap(
  alist(
    played ~ dnorm(mu, sigma),
    mu <- a + bW * weight + bS * shorthop + bG * grab + bR * run,
    a ~ dnorm(0, .2),
    bW ~ dnorm(0, .5),
    bS ~ dnorm(0, .5),
    bG ~ dnorm(0, .5),
    bR ~ dnorm(0, .5),
    sigma ~ dexp(1)
  ), data = smash1
)

# Plot Precis
plot(precis(m1.1))

```

So we can see that there the variables are straddling 0 but there is some pull for *Grab* and *Run Speed*. However, I think that I still need to fix this to see if there is something else influencing this.

### Iteration 2

I want to see if I don't include some variables if it changes things.

```{r}

# Standardize and Index Variables
smash1.2 <- tibble(
  played = standardize(smash_tidy$per_played),
  shorthop = standardize(as.numeric(smash_tidy$shorthop_height)),
  grab = standardize(as.numeric(smash_tidy$Grab.Range)),
  run = standardize(smash_tidy$Run.Speed)
)

# Initial Density Graphs
dens(smash1.2$played)
dens(smash1.2$shorthop)
dens(smash1.2$grab)
dens(smash1.2$run)

```

There are a couple of outliers happening in grab and run. I think this is because there are a few characters that are known to have this extreme stats. So it is not surprising, but I might need to log these two variables.

I also do not have any discrete varables at the moment. In a later iteration this may change especially as I group by character.

### Build Model

```{r m1.2}

# Omit NA's
smash1.2 <- smash1.2 %>% 
  na.omit()

# Fit Model
m1.2 <- quap(
  alist(
    played ~ dnorm(mu, sigma),
    mu <- a + bS * shorthop + bG * grab + bR * run,
    a ~ dnorm(0, .2),
    bS ~ dnorm(0, .5),
    bG ~ dnorm(0, .5),
    bR ~ dnorm(0, .5),
    sigma ~ dexp(1)
  ), data = smash1.2
)

# Plot Precis
plot(precis(m1.2))

```

No difference. So let's look at some new variables.

### Iteration 3

```{r}

# Standardize and Index Variables
smash1.3 <- tibble(
  played = standardize(smash_tidy$per_played),
  weight = standardize(smash_tidy$Weight),
  shorthop = standardize(as.numeric(smash_tidy$shorthop_height)),
  grab = standardize(as.numeric(smash_tidy$Grab.Range)),
  run = standardize(smash_tidy$Run.Speed),
  character = smash_tidy$character
) %>% 
  drop_na()

```

```{r m1.3}

# Fit Model
m1.3 <- quap(
  alist(
    played ~ dnorm(mu, sigma),
    mu <- a + bW * weight,
    a ~ dnorm(0, .2),
    bW ~ dnorm(0, .5),
    sigma ~ dexp(1)
  ), data = smash1.3
)

# Plot Precis
plot(precis(m1.3))

```


